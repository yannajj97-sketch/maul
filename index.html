<?php
session_start();

/* ===== KONEKSI DATABASE ===== */
$conn = mysqli_connect("localhost","root","","grub_db");
if(!$conn){ die("Koneksi gagal"); }

/* ===== LOGIN SYSTEM ===== */
if(isset($_POST['login'])){
    $user = $_POST['username'];
    $pass = $_POST['password'];

    $query = mysqli_query($conn,"SELECT * FROM admin WHERE username='$user'");
    $data = mysqli_fetch_assoc($query);

    if($data && password_verify($pass,$data['password'])){
        $_SESSION['admin']=$user;
    } else {
        $error="Login gagal!";
    }
}

/* ===== LOGOUT ===== */
if(isset($_GET['logout'])){
    session_destroy();
    header("Location: grub_maul_ling.php");
}

/* ===== TAMBAH KEUANGAN ===== */
if(isset($_POST['tambah'])){
    $bulan=$_POST['bulan'];
    $pendapatan=$_POST['pendapatan'];
    mysqli_query($conn,"INSERT INTO keuangan (bulan,pendapatan)
    VALUES ('$bulan','$pendapatan')");
}

/* ===== UPDATE PROFIL ===== */
if(isset($_POST['update_profil'])){
    $nama_ceo=$_POST['nama_ceo'];
    $visi=$_POST['visi'];

    mysqli_query($conn,"UPDATE profil_perusahaan 
    SET nama_ceo='$nama_ceo', visi='$visi' WHERE id=1");
}

/* ===== AMBIL DATA PROFIL ===== */
$profil=mysqli_query($conn,"SELECT * FROM profil_perusahaan LIMIT 1");
$dataProfil=mysqli_fetch_assoc($profil);

/* ===== AMBIL DATA KEUANGAN ===== */
$dataKeuangan=mysqli_query($conn,"SELECT * FROM keuangan");
$bulan=[]; $pendapatan=[];
while($row=mysqli_fetch_assoc($dataKeuangan)){
    $bulan[]=$row['bulan'];
    $pendapatan[]=$row['pendapatan'];
}
?>

<!DOCTYPE html>
<html>
<head>
<title>GRUB MAUL LING</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{background:#0f172a;color:white;}
.hero{height:100vh;display:flex;justify-content:center;align-items:center;text-align:center;}
.gold{color:gold;}
</style>
</head>
<body>

<?php if(!isset($_SESSION['admin'])){ ?>

<!-- ===== LANDING PAGE ===== -->

<div class="hero">
<div>
<h1 class="gold">GRUB MAUL LING</h1>
<h3>CEO: MAULANA AR ROSYID</h3>
<p><?php echo $dataProfil['visi']; ?></p>
<button class="btn btn-warning" data-bs-toggle="collapse" data-bs-target="#loginForm">Login Admin</button>

<div id="loginForm" class="collapse mt-3">
<form method="POST">
<input type="text" name="username" placeholder="Username" class="form-control mb-2">
<input type="password" name="password" placeholder="Password" class="form-control mb-2">
<button name="login" class="btn btn-light">Login</button>
</form>
<?php if(isset($error)) echo "<p class='text-danger'>$error</p>"; ?>
</div>
</div>
</div>

<?php } else { ?>

<!-- ===== DASHBOARD ===== -->

<div class="container mt-5">
<h1 class="gold">Dashboard Enterprise</h1>
<a href="?logout=true" class="btn btn-danger mb-3">Logout</a>

<h3>Profil Perusahaan</h3>
<p><b>CEO:</b> <?php echo $dataProfil['nama_ceo']; ?></p>
<p><b>Visi:</b> <?php echo $dataProfil['visi']; ?></p>

<form method="POST">
<input type="text" name="nama_ceo" placeholder="Nama CEO" class="form-control mb-2">
<textarea name="visi" placeholder="Visi" class="form-control mb-2"></textarea>
<button name="update_profil" class="btn btn-warning">Update Profil</button>
</form>

<hr>

<h3>Tambah Data Keuangan</h3>
<form method="POST">
<input type="text" name="bulan" placeholder="Bulan" class="form-control mb-2">
<input type="number" name="pendapatan" placeholder="Pendapatan" class="form-control mb-2">
<button name="tambah" class="btn btn-success">Tambah</button>
</form>

<hr>

<h3>Grafik Keuangan</h3>
<canvas id="chart"></canvas>

</div>

<script>
new Chart(document.getElementById('chart'),{
type:'line',
data:{
labels: <?php echo json_encode($bulan); ?>,
datasets:[{
label:'Pendapatan',
data: <?php echo json_encode($pendapatan); ?>,
borderColor:'gold',
backgroundColor:'rgba(255,215,0,0.3)',
tension:0.4
}]
}
});
</script>

<?php } ?>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
